<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self' 'unsafe-inline' 'unsafe-eval'; media-src 'self' file: blob:; img-src 'self' https: data:; connect-src 'self' https://api.discogs.com">
  <title>AutoSlice</title>
  <link rel="stylesheet" href="styles/main.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
  <div id="app">
    <!-- ── Top Bar ── -->
    <header id="toolbar">
      <div class="toolbar-left">
        <div class="app-logo">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <rect x="2" y="6" width="3" height="12" rx="1.5" fill="#7c5cfc" />
            <rect x="7" y="3" width="3" height="18" rx="1.5" fill="#a78bfa" />
            <rect x="12" y="8" width="3" height="8" rx="1.5" fill="#7c5cfc" />
            <rect x="17" y="4" width="3" height="16" rx="1.5" fill="#a78bfa" />
          </svg>
          <span class="app-title">AutoSlice</span>
        </div>
      </div>
      <div class="toolbar-center">
        <span id="fileNameDisplay" class="file-name">No file loaded</span>
        <span id="fileInfoDisplay" class="file-info"></span>
      </div>
      <div class="toolbar-right">
        <button id="btnShortcuts" class="btn btn-icon btn-ghost" title="Keyboard Shortcuts">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
        </button>
        <button id="btnAbout" class="btn btn-icon btn-ghost" title="About AutoSlice">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
        </button>
        <button id="btnSettings" class="btn btn-icon btn-ghost" title="Settings">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        </button>
        <div class="separator" style="width: 1px; height: 24px; background: var(--border); margin: 0 5px;"></div>
        <button id="btnOpenFile" class="btn btn-ghost" title="Open file">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
            <polyline points="14,2 14,8 20,8" />
          </svg>
          Open
        </button>
        <button id="btnCloseProject" class="btn btn-ghost" title="Close project" style="display:none">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg>
          Close
        </button>
      </div>
    </header>

    <!-- ── Drop Zone (shown when no file) ── -->
    <div id="dropZone" class="drop-zone">
      <div class="drop-zone-content">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
          opacity="0.4">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
          <polyline points="17 8 12 3 7 8" />
          <line x1="12" y1="3" x2="12" y2="15" />
        </svg>
        <h2>Drop audio file here</h2>
        <p>WAV, FLAC, AIFF, MP3</p>
        <span class="drop-zone-hint">or click Open above</span>
      </div>
    </div>

    <!-- ── Main Content (hidden until file loaded) ── -->
    <main id="mainContent" class="main-content hidden">
      <!-- Waveform Panel -->
      <section id="waveformPanel" class="panel waveform-panel">
        <div class="panel-header">
          <div class="panel-title">Waveform</div>
          <div class="waveform-controls">
            <button id="btnZoomOut" class="btn btn-icon" title="Zoom Out">−</button>
            <input id="zoomSlider" type="range" min="1" max="500" value="1" class="zoom-slider">
            <button id="btnZoomIn" class="btn btn-icon" title="Zoom In">+</button>
            <button id="btnZoomFit" class="btn btn-sm" title="Fit entire audio in view">Fit</button>
            <div class="separator"></div>
            <button id="btnToggleSpectrogram" class="btn btn-sm" title="Toggle Spectrogram">Spectrogram</button>
          </div>
        </div>
        <div id="waveformContainer" class="waveform-container">
          <div id="waveformTooltip" class="waveform-tooltip"></div>
          <div id="excludeModeBadge" class="exclude-mode-badge" style="display:none"></div>
        </div>
        <div id="spectrogramContainer" class="spectrogram-container hidden"></div>
        <div id="timelineInfo" class="timeline-info">
          <span id="currentTime">0:00</span>
          <span id="totalTime">0:00</span>
          <span id="excludedDurationSummary" class="excluded-summary" style="display:none"></span>
        </div>
      </section>

      <!-- Controls Panel -->
      <section class="controls-row">
        <!-- Playback Controls -->
        <div class="panel control-group playback-controls">
          <button id="btnPlayPause" class="btn btn-primary btn-play" title="Play / Pause">
            <svg id="iconPlay" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <polygon points="5,3 19,12 5,21" />
            </svg>
            <svg id="iconPause" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="hidden">
              <rect x="6" y="4" width="4" height="16" />
              <rect x="14" y="4" width="4" height="16" />
            </svg>
          </button>
          <button id="btnStop" class="btn btn-ghost" title="Stop">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
              <rect x="6" y="6" width="12" height="12" rx="1" />
            </svg>
          </button>
        </div>

        <!-- Detection Controls -->
        <div class="panel control-group detection-controls">
          <h3>Detection</h3>
          <div class="param-grid">
            <label>Threshold
              <div class="param-input">
                <input id="paramThreshold" type="range" min="-80" max="-10" value="-40" step="1">
                <span id="paramThresholdVal">-40 dB</span>
              </div>
            </label>
            <label>Min Silence
              <div class="param-input">
                <input id="paramMinSilence" type="range" min="200" max="10000" value="1500" step="100">
                <span id="paramMinSilenceVal">1500 ms</span>
              </div>
            </label>
            <label>Sensitivity
              <div class="param-input">
                <input id="paramSensitivity" type="range" min="0" max="100" value="50" step="5">
                <span id="paramSensitivityVal">50%</span>
              </div>
            </label>
          </div>
          <div class="detection-actions">
            <label class="checkbox-label">
              <input id="paramAutoThreshold" type="checkbox" checked>
              Auto threshold
            </label>
            <button id="btnAutoDetect" class="btn btn-accent" title="Analyze audio and auto-detect silence gaps">⚡ Auto
              Detect</button>
          </div>
        </div>

        <!-- Marker Controls -->
        <div class="panel control-group marker-controls">
          <h3>Markers</h3>
          <div class="marker-actions">
            <button id="btnAddMarker" class="btn btn-sm" title="Add a marker at the current playback position (M)">+ Add at cursor</button>
            <button id="btnClearMarkers" class="btn btn-sm btn-danger" title="Remove all markers">Clear markers</button>
            <button id="btnClearExclusions" class="btn btn-sm btn-danger" title="Remove all excluded regions (E to toggle mode)">Clear exclusions</button>
          </div>
          <div id="markerCount" class="marker-count">0 markers · 1 track</div>
        </div>
      </section>

      <!-- Tracks & Discogs Panel -->
      <section class="bottom-panels">
        <!-- Track List -->
        <div class="panel track-list-panel">
          <div class="panel-header">
            <div class="panel-title">Tracks</div>
            <div class="panel-header-right">
              <button id="btnSmartImport" class="btn btn-sm btn-ghost" title="Paste tracklist text">Import Text</button>
              <div id="trackCountBadge" class="badge">0</div>
            </div>
          </div>
          <div id="trackList" class="track-list">
            <div class="empty-state">Run Auto Detect to find tracks</div>
          </div>
        </div>

        <!-- Discogs Panel -->
        <div class="panel discogs-panel">
          <div class="panel-header">
            <div class="panel-title">Discogs</div>
            <button id="btnDiscogsToggle" class="btn btn-sm btn-ghost">Search</button>
          </div>
          <div id="discogsContent" class="discogs-content">
            <div class="discogs-search">
              <input id="discogsArtist" type="text" placeholder="Artist" class="input">
              <input id="discogsAlbum" type="text" placeholder="Album" class="input">
              <input id="discogsToken" type="text" placeholder="Discogs Token (optional)" class="input input-sm">
              <button id="btnDiscogsSearch" class="btn btn-sm btn-accent">Search</button>
            </div>
            <div id="discogsResults" class="discogs-results"></div>
            <div id="discogsTracklist" class="discogs-tracklist hidden"></div>
          </div>
        </div>
      </section>

      <!-- Export Bar -->
      <footer id="exportBar" class="export-bar" style="flex-direction: column; gap: 10px; padding: 15px;">
        <div class="export-options" style="flex-wrap: wrap; width: 100%; align-items: flex-end;">
          <label>Format
            <select id="exportFormat" class="select">
              <option value="flac">FLAC</option>
              <option value="wav">WAV</option>
              <option value="mp3">MP3 320kbps</option>
            </select>
          </label>
          <label>Artist
            <input id="exportArtist" type="text" placeholder="Artist" class="input">
          </label>
          <label>Album
            <input id="exportAlbum" type="text" placeholder="Album" class="input">
          </label>
          <label>Year
            <input id="exportYear" type="text" placeholder="Year" class="input input-sm">
          </label>
          <button id="btnToggleAdvancedExport" class="btn btn-ghost btn-sm" style="margin-bottom: 2px;">Advanced ▾</button>
        </div>

        <div id="advancedExportOptions" class="export-options hidden" style="flex-wrap: wrap; width: 100%; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; border: 1px solid var(--border);">
           <label>Album Artist <input id="exportAlbumArtist" type="text" placeholder="Album Artist" class="input input-sm"></label>
           <label>Genre <input id="exportGenre" type="text" placeholder="Genre" class="input input-sm"></label>
           <label>Comment <input id="exportComment" type="text" placeholder="Comment" class="input input-sm"></label>
           <label>Sample Rate
             <select id="exportSampleRate" class="select select-sm">
               <option value="">Original</option>
               <option value="44100">44.1 kHz</option>
               <option value="48000">48.0 kHz</option>
               <option value="96000">96.0 kHz</option>
             </select>
           </label>
           <label style="display:flex; flex-direction: column; justify-content: flex-end;">
             <span style="font-size:12px;color:var(--text-muted);margin-bottom:4px;">Audio</span>
             <label class="checkbox-label"><input id="exportNormalize" type="checkbox"> Normalize</label>
           </label>
           <label>Cover Art
             <div style="display: flex; gap: 5px;">
               <input id="exportCoverPath" type="text" class="input input-sm" readonly placeholder="No file selected">
               <button id="btnSelectCover" class="btn btn-sm">Browse</button>
             </div>
           </label>
        </div>

        <div style="display: flex; justify-content: flex-end; width: 100%;">
          <button id="btnExport" class="btn btn-primary btn-export" style="align-self: flex-end;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="7 10 12 15 17 10" />
              <line x1="12" y1="15" x2="12" y2="3" />
            </svg>
            Export Tracks
          </button>
        </div>
      </footer>
    </main>

    <!-- Status / Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
      <div class="loading-spinner"></div>
      <div id="loadingText" class="loading-text">Processing...</div>
    </div>
    
    <!-- Export Progress Overlay -->
    <div id="exportProgressOverlay" class="loading-overlay hidden" style="flex-direction: column;">
       <h3 style="margin-bottom: 15px;">Exporting Tracks...</h3>
       <div style="width: 350px; background: rgba(255,255,255,0.1); height: 12px; border-radius: 6px; overflow: hidden; margin-bottom: 10px;">
          <div id="exportProgressBar" style="width: 0%; height: 100%; background: var(--accent); transition: width 0.3s ease;"></div>
       </div>
       <div id="exportProgressText" style="margin-bottom: 5px; font-weight: 500;">Starting export...</div>
       <div id="exportETA" style="font-size: 0.9em; color: var(--text-muted);">Calculating ETA...</div>
       
       <div id="exportSuccessActions" class="hidden" style="margin-top: 25px; display: flex; gap: 10px;">
         <button id="btnCopyOutputPath" class="btn btn-ghost">Copy Output Path</button>
         <button id="btnOpenOutputDir" class="btn btn-primary">Open Folder</button>
         <button id="btnCloseExportProgress" class="btn btn-accent">Close</button>
       </div>
    </div>
    <!-- Smart Import Modal -->
    <div id="smartImportModal" class="modal-overlay hidden">
      <div class="modal">
        <div class="modal-header">
          <h3>Smart Track Import</h3>
          <div class="modal-header-actions" style="display: flex; gap: 8px; align-items: center;">
            <select id="smartImportHistory" class="select select-sm" style="display:none"></select>
            <button id="btnCopyTracklist" class="btn btn-sm btn-ghost" title="Copy Tracklist">Copy</button>
            <button id="btnCloseSmartImport" class="btn btn-icon">×</button>
          </div>
        </div>
        <p class="modal-hint">Paste tracklist below or Drag & Drop .txt/.cue files. Supports timestamps (e.g., [0:00] Title) or plain titles.</p>
        <textarea id="smartImportText" class="smart-import-input"
          placeholder="0:00 Intro&#10;3:45 Track 2..."></textarea>

        <div class="smart-import-controls" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <button id="btnParseSmartImport" class="btn btn-accent" style="display:flex; align-items:center; gap:5px;">
              <span class="btn-text">Parse</span>
              <svg class="spinner hidden" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="animation: spin 1s linear infinite;"><line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line><line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line x1="16.24" y1="4.93" x2="19.07" y2="7.76"></line></svg>
            </button>
            <span id="smartImportTrackCount" class="text-muted" style="font-size: 0.9em; display: none;"></span>
          </div>
          <div style="display: flex; gap: 15px;">
            <label class="checkbox-label" title="Replace existing markers with imported ones">
              <input id="checkSmartImportReplace" type="radio" name="smartImportMode" value="replace" checked>
              Replace existing
            </label>
            <label class="checkbox-label" title="Append imported tracks to the end of existing markers">
              <input id="checkSmartImportAppend" type="radio" name="smartImportMode" value="append">
              Append
            </label>
          </div>
        </div>

        <div id="smartImportPreview" class="smart-import-preview hidden" style="margin-top: 10px;">
          <!-- Preview content injected here -->
        </div>

        <div class="modal-footer" style="margin-top: 15px;">
          <button id="btnCancelSmartImport" class="btn btn-ghost">Cancel</button>
          <button id="btnApplySmartImport" class="btn btn-primary">Import</button>
        </div>
      </div>
    </div>

  </div>

  <!-- Modals -->
  <!-- Settings Modal -->
  <div id="settingsModal" class="modal-overlay hidden">
    <div class="modal">
      <div class="modal-header">
        <h3>Settings</h3>
        <button id="btnCloseSettings" class="btn btn-icon">×</button>
      </div>
      <div class="param-grid" style="grid-template-columns: 1fr; gap: 15px;">
        <label>Default Export Format
          <select id="settingDefaultFormat" class="select">
            <option value="flac">FLAC</option>
            <option value="wav">WAV</option>
            <option value="mp3">MP3 320kbps</option>
          </select>
        </label>
        <label>Default Output Directory
          <div style="display: flex; gap: 5px;">
            <input id="settingDefaultOutputDir" type="text" class="input" readonly placeholder="Ask every time">
            <button id="btnSetDefaultOutputDir" class="btn btn-sm">Browse</button>
            <button id="btnClearDefaultOutputDir" class="btn btn-sm btn-ghost" title="Clear">×</button>
          </div>
        </label>
        <label>Waveform Theme
          <select id="settingWaveformTheme" class="select">
            <option value="purple">Purple (Default)</option>
            <option value="blue">Ocean Blue</option>
            <option value="green">Neon Green</option>
          </select>
        </label>
      </div>
      <div class="modal-footer" style="margin-top: 20px;">
        <button id="btnApplySettings" class="btn btn-primary">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Shortcuts Modal -->
  <div id="shortcutsModal" class="modal-overlay hidden">
    <div class="modal">
      <div class="modal-header">
        <h3>Keyboard Shortcuts</h3>
        <button id="btnCloseShortcuts" class="btn btn-icon">×</button>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
        <div><strong>Space</strong></div><div>Play / Pause</div>
        <div><strong>M</strong></div><div>Add Marker at cursor</div>
        <div><strong>Delete / Backspace</strong></div><div>Remove marker near cursor</div>
        <div><strong>E</strong></div><div>Toggle Exclude region mode</div>
        <div><strong>Home / End</strong></div><div>Seek to Start / End</div>
        <div><strong>Ctrl + I</strong></div><div>Open Smart Import</div>
        <div><strong>Ctrl + Scroll</strong></div><div>Zoom Waveform</div>
        <div><strong>+ / -</strong></div><div>Zoom In / Out</div>
      </div>
    </div>
  </div>

  <!-- About Modal -->
  <div id="aboutModal" class="modal-overlay hidden">
    <div class="modal" style="text-align: center;">
      <div class="modal-header" style="justify-content: flex-end;">
        <button id="btnCloseAbout" class="btn btn-icon">×</button>
      </div>
      <h2>AutoSlice</h2>
      <p style="color: var(--text-muted); margin-bottom: 20px;">Version 0.1.0</p>
      <p style="font-size: 0.9em; margin-bottom: 10px;">A smart audio track detector and slicer.</p>
      <p style="font-size: 0.8em; color: var(--text-muted);">Built with Electron, WaveSurfer.js, and FFmpeg.</p>
    </div>
  </div>

  <!-- Toast Notifications -->
  <div id="toastContainer" class="toast-container"></div>
  <script src="app.js" type="module"></script>
</body>

</html>